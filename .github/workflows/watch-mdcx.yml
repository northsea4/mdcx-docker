name: Watch MDCx Release

on:
  push:
    branches:
      - none
  schedule:
    # æ¯45åˆ†é’Ÿ
    - cron: '*/45 * * * *'
  
  workflow_dispatch:
    inputs:
      isDev:
        description: Is Dev
        type: boolean

env:
  RELEASE_URL: 'https://api.github.com/repos/anyabc/something/releases/latest'
  ENABLE_WATCH: ${{ secrets.ENABLE_WATCH_MDCX_RELEASE }}
  GITHUB_CURRENT_REPO: ${{ github.event.repository.name }}
  GITHUB_API_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
  GITHUB_OWNER: ${{ github.repository_owner }}

jobs:
  # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
  watch:
    runs-on: ubuntu-latest
    steps:
      -
        run: |
          # TODO åœ¨jobä¸Šè²Œä¼¼ä¸èƒ½è¯»å–envæˆ–è€…secrets

          if [[ "${{ env.ENABLE_WATCH }}" != "true" && "${{ github.event.inputs.isDev }}" != "true" ]]; then
            exit 1
          fi
      - 
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Install apt packages
        run: sudo apt-get install -y jq
      -
        name: Check if there is a new MDCx release
        id: check
        env:
          GITHUB_CURRENT_REPO: ${{ env.GITHUB_CURRENT_REPO }}
          GITHUB_API_TOKEN: ${{ env.GITHUB_API_TOKEN }}
          CURL_VERBOSE: '-s'
        run: |
          source scripts/base.sh
          source scripts/github.sh

          VAR_VERSION="MDCX_LATEST_VERSION"
          VAR_TIME="MDCX_LATEST_TIME"

          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¿”å›å€¼ä¸ºæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç‰ˆæœ¬å·ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸ºæ›´æ–°æ—¶é—´
          getNewInfo() {
            local content=$(curl -s "${{ env.RELEASE_URL }}")
            local asset=$(echo $content | jq '.assets'| jq 'map(select(.browser_download_url | contains("-py-")))' | jq '.[0]')

            if [[ -z "$asset" ]]; then
              echo "âŒ æŸ¥æ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„assetï¼"
              return 1
            fi

            # https://gitbook.curiouser.top/origin/linux-jq.html#%E4%B8%89%E3%80%81jq%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0
            # -r    å¦‚æœè¿‡æ»¤çš„ç»“æœæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆç›´æ¥å†™åˆ°æ ‡å‡†è¾“å‡ºï¼ˆå»æ‰å­—ç¬¦ä¸²çš„å¼•å·ï¼‰;
            local archiveUrl=$(echo $asset | jq -r '.browser_download_url')
            local updatedAt=$(echo $asset | jq -r '.updated_at')

            if [[ -z "$archiveUrl" ]]; then
              echo "âŒ è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼"
              return 1
            fi

            if [[ -z "$updatedAt" ]]; then
              echo "âŒ è·å–æ›´æ–°æ—¶é—´å¤±è´¥ï¼"
              return 1
            fi

            local archiveFullName=$(echo $archiveUrl | grep -oi 'MDCx-py-[a-z0-9]\+.[a-z]\+')
            local archiveVersion=$(echo $archiveFullName | sed 's/MDCx-py-//g' | sed 's/\.[^.]*$//')

            local info=("$archiveVersion" "$updatedAt")
            echo "${info[@]}"
            return 0
          }

          newVersion=""
          newTime=""
          hasNewVersion=false

          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          info=($(getNewInfo))
          newVersion=${info[0]}
          newTime=${info[1]}

          # è·å–å·²è®°å½•çš„ç‰ˆæœ¬ä¿¡æ¯
          latestVersion=$(getVariable $VAR_VERSION)
          latestTime=$(getVariable $VAR_TIME)
          echo "ğŸ“¦ å·²è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼š$latestVersion"
          echo "ğŸ“… å·²è®°å½•çš„æ›´æ–°æ—¶é—´ï¼š$latestTime"

          # ä»»æ„ä¸€ä¸ªå˜é‡ä¸ºç©ºï¼Œéƒ½ä¸è§†ä¸ºæ–°ç‰ˆæœ¬
          if [[ -z "$latestVersion" || -z "$latestTime" ]]; then
            hasNewVersion=false
          else
            # å¦‚æœç‰ˆæœ¬å·æˆ–è€…æ›´æ–°æ—¶é—´ä¸åŒï¼Œè§†ä¸ºæ–°ç‰ˆæœ¬
            if [[ "$newVersion" != "$latestVersion" || "$newTime" != "$latestTime" ]]; then
              hasNewVersion=true
            else
              hasNewVersion=false
            fi
          fi


          # è¾“å‡ºåˆ°GITHUB_OUTPUT 
          echo "newVersion=$newVersion" >> $GITHUB_OUTPUT
          echo "newTime=$newTime" >> $GITHUB_OUTPUT
          echo "hasNewVersion=$hasNewVersion" >> $GITHUB_OUTPUT
          echo "latestVersion=$latestVersion" >> $GITHUB_OUTPUT
          echo "latestTime=$latestTime" >> $GITHUB_OUTPUT
   
          if [[ "$hasNewVersion" == "true" ]]; then
            echo "ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼"
            echo "ğŸ“¦ æ–°ç‰ˆæœ¬å·ï¼š$newVersion"
            echo "ğŸ“… æ›´æ–°æ—¶é—´ï¼š$newTime"

            updateVariable $VAR_TIME "$newTime"

            updateVariable $VAR_VERSION "$newVersion"

            exit 0
          else
            echo "ğŸ” æ²¡æœ‰æ–°ç‰ˆæœ¬ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥..."
          fi
      -
        uses: appleboy/telegram-action@master
        if: ${{ steps.check.outputs.hasNewVersion == 'true' }}
        with:
          to: ${{ secrets.TELE_CHAT_ID }}
          token: ${{ secrets.TELE_BOT_TOKEN }}
          message: |
            ğŸ‰ MDCxæ–°ç‰ˆæœ¬ï¼
            ğŸ“¦ æ–°ç‰ˆæœ¬å·ï¼š${{ steps.check.outputs.newVersion }}
            ğŸ“… æ›´æ–°æ—¶é—´ï¼š${{ steps.check.outputs.newTime }}
            ğŸ”— å‘å¸ƒé“¾æ¥ï¼šhttps://github.com/anyabc/something/releases/tag/MDCx
      # -
      #   uses: appleboy/telegram-action@master
      #   if: ${{ steps.check.outputs.hasNewVersion == 'false' }}
      #   with:
      #     to: ${{ secrets.TELE_CHAT_ID }}
      #     token: ${{ secrets.TELE_BOT_TOKEN }}
      #     message: |
      #       ğŸ” æ²¡æœ‰æ–°ç‰ˆæœ¬ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥...
  
