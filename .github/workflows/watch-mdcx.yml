name: Watch MDCx Release

on:
  push:
    branches:
      - none
  schedule:
    # æ¯30åˆ†é’Ÿ
    - cron: '*/30 * * * *'
  
  workflow_dispatch:
    inputs:
      isDev:
        description: Is Dev
        type: boolean

env:
  RELEASE_URL: 'https://api.github.com/repos/sqzw-x/mdcx/releases/latest'
  ENABLE_WATCH: ${{ secrets.ENABLE_WATCH_MDCX_RELEASE }}
  GITHUB_CURRENT_REPO: ${{ github.event.repository.name }}
  GITHUB_API_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
  GITHUB_OWNER: ${{ github.repository_owner }}
  ENABLE_TG_NOTIFICATION: ${{ secrets.ENABLE_TG_NOTIFICATION }}
  ENABLE_TG_VERBOSE_NOTIFICATION: ${{ secrets.ENABLE_TG_VERBOSE_NOTIFICATION }}
  SCHEDULE_INTERVAL: 30

jobs:
  # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
  # TODO æ¸…ç†Nå¤©å‰çš„runs
  watch:
    runs-on: ubuntu-latest
    steps:
      -
        run: |
          # TODO åœ¨jobä¸Šè²Œä¼¼ä¸èƒ½è¯»å–envæˆ–è€…secrets

          if [[ "${{ env.ENABLE_WATCH }}" != "true" && "${{ github.event.inputs.isDev }}" != "true" ]]; then
            exit 1
          fi
      -
        name: Set timezone
        uses: szenius/set-timezone@v1.0
        with:
          timezoneLinux: "Asia/Shanghai"
      - 
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Install apt packages
        run: sudo apt-get install -y jq
      -
        name: Check if there is a new MDCx release
        id: check
        env:
          GITHUB_CURRENT_REPO: ${{ env.GITHUB_CURRENT_REPO }}
          GITHUB_API_TOKEN: ${{ env.GITHUB_API_TOKEN }}
          CURL_VERBOSE: '-s'
        run: |
          source scripts/base.sh
          source scripts/github.sh
          source scripts/release-utils.sh

          VAR_VERSION="MDCX_LATEST_VERSION"
          VAR_TIME="MDCX_LATEST_TIME"

          REPO="sqzw-x/mdcx"
          TAG_NAME="daily_release"

          REPO="sqzw-x/mdcx"
          TAG_NAME="daily_release"

          info=$(get_release_info "$REPO" "$TAG_NAME")
          if [[ $? -ne 0 ]]; then
            echo "âŒ è·å–ä»“åº“ ${REPO} ä¸­ tag_name=${TAG_NAME} çš„releaseä¿¡æ¯å¤±è´¥ï¼"
            exit 1
          else
            echo "âœ… è·å–ä»“åº“ ${REPO} ä¸­ tag_name=${TAG_NAME} çš„releaseä¿¡æ¯æˆåŠŸï¼"
          fi
          echo $info | jq

          # å‘å¸ƒæ—¶é—´
          published_at=$(printf '%s' $info | jq -r ".published_at")
          echo "ğŸ“… å‘å¸ƒæ—¶é—´: $published_at"

          # ç‰ˆæœ¬å·
          release_version=$(printf '%s' $info | jq -r ".release_version")
          echo "ğŸ”¢ ç‰ˆæœ¬å·: $release_version"

          newVersion=""
          newTime=""
          hasNewVersion=false

          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          info=($(getNewInfo))
          newVersion="$release_version"
          newTime="$published_at"

          # è·å–å·²è®°å½•çš„ç‰ˆæœ¬ä¿¡æ¯
          latestVersion=$(getVariable $VAR_VERSION)
          latestTime=$(getVariable $VAR_TIME)
          echo "ğŸ“¦ å·²è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼š$latestVersion"
          echo "ğŸ“… å·²è®°å½•çš„æ›´æ–°æ—¶é—´ï¼š$latestTime"

          # ä»»æ„ä¸€ä¸ªå˜é‡ä¸ºç©ºï¼Œéƒ½ä¸è§†ä¸ºæ–°ç‰ˆæœ¬
          if [[ -z "$latestVersion" || -z "$latestTime" ]]; then
            hasNewVersion=false
          else
            # å¦‚æœç‰ˆæœ¬å·æˆ–è€…æ›´æ–°æ—¶é—´ä¸åŒï¼Œè§†ä¸ºæ–°ç‰ˆæœ¬
            if [[ "$newVersion" != "$latestVersion" || "$newTime" != "$latestTime" ]]; then
              hasNewVersion=true
            else
              hasNewVersion=false
            fi
          fi


          # è¾“å‡ºåˆ°GITHUB_OUTPUT 
          echo "newVersion=$newVersion" >> $GITHUB_OUTPUT
          echo "newTime=$newTime" >> $GITHUB_OUTPUT
          echo "hasNewVersion=$hasNewVersion" >> $GITHUB_OUTPUT
          echo "latestVersion=$latestVersion" >> $GITHUB_OUTPUT
          echo "latestTime=$latestTime" >> $GITHUB_OUTPUT
          # å½“å‰æ—¶é—´
          echo "currentTime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          # ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´
          echo "nextCheckTime=$(date -d "+${{ env.SCHEDULE_INTERVAL }} minutes" '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
   
          if [[ "$hasNewVersion" == "true" ]]; then
            echo "ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼"
            echo "ğŸ“¦ æ–°ç‰ˆæœ¬å·ï¼š$newVersion"
            echo "ğŸ“… æ›´æ–°æ—¶é—´ï¼š$newTime"

            updateVariable $VAR_TIME "$newTime"

            updateVariable $VAR_VERSION "$newVersion"

            exit 0
          else
            echo "ğŸ” æ²¡æœ‰æ–°ç‰ˆæœ¬ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥..."
          fi
      -
        name: TG Notification - For new version
        uses: appleboy/telegram-action@master
        if: ${{ steps.check.outputs.hasNewVersion == 'true' && env.ENABLE_TG_NOTIFICATION == 'true' }}
        with:
          to: ${{ secrets.TELE_CHAT_ID }}
          token: ${{ secrets.TELE_BOT_TOKEN }}
          message: |
            ğŸ‰ MDCxæ–°ç‰ˆæœ¬ï¼
            ğŸ“¦ æ–°ç‰ˆæœ¬å·ï¼š${{ steps.check.outputs.newVersion }}
            ğŸ“… æ›´æ–°æ—¶é—´ï¼š${{ steps.check.outputs.newTime }}
            ğŸ”— å‘å¸ƒé“¾æ¥ï¼šhttps://github.com/sqzw-x/mdcx/releases/tag/latest
      -
        name: TG Notification - For no new version
        uses: appleboy/telegram-action@master
        if: ${{ steps.check.outputs.hasNewVersion == 'false' && env.ENABLE_TG_VERBOSE_NOTIFICATION == 'true' }}
        with:
          to: ${{ secrets.TELE_CHAT_ID }}
          token: ${{ secrets.TELE_BOT_TOKEN }}
          message: |
            ğŸ”” MDCxæ–°ç‰ˆæœ¬æ£€æŸ¥é€šçŸ¥ - æ²¡æœ‰æ–°ç‰ˆæœ¬
            ğŸ“¦ æœ€æ–°ç‰ˆæœ¬ï¼š${{ steps.check.outputs.latestVersion }}
            ğŸ“… å‘å¸ƒæ—¶é—´ï¼š${{ steps.check.outputs.latestTime }}
            â° æ£€æŸ¥æ—¶é—´ï¼š${{ steps.check.outputs.currentTime }}
            â° ä¸‹æ¬¡æ£€æŸ¥ï¼š${{ steps.check.outputs.nextCheckTime }}
      -
        name: Trigger "Image build-mdcx CI"
        if: ${{ steps.check.outputs.hasNewVersion == 'true' }}
        run: |
          # Personal Access Token
          TOKEN="${{ env.GITHUB_API_TOKEN }}"

          # GitHub Repoåç§°
          REPO="${{ env.GITHUB_OWNER }}/${{ env.GITHUB_CURRENT_REPO }}"

          # Workflow Name
          WORKFLOW_NAME="Image build-mdcx CI"

          # æ ¹æ®åç§°è·å–workflow id
          WORKFLOW_ID=$(curl -s -H "Authorization: Bearer ${TOKEN}" \
          "https://api.github.com/repos/${REPO}/actions/workflows" \
          | jq -r ".workflows | .[] | select(.name==\"${WORKFLOW_NAME}\") | .id")

          if [[ -z "$WORKFLOW_ID" ]]; then
            echo "âŒ è·å–workflow idå¤±è´¥ï¼"
            exit 1
          else
            echo "ğŸ“¦ workflow idï¼š$WORKFLOW_ID"
          fi

          echo "ğŸš€ è§¦å‘æ„å»º..."
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}"\
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${REPO}/actions/workflows/${WORKFLOW_ID}/dispatches \
            -d '{"ref":"main","inputs":{"stage":"prod","baseImage":"latest"}}'

          if [[ $? -ne 0 ]]; then
            echo "âŒ è§¦å‘æ„å»ºå¤±è´¥ï¼"
            exit 1
          fi
  
