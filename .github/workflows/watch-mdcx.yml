name: Watch MDCx Release

on:
  push:
    branches:
      - none
  schedule:
    # æ¯10åˆ†é’Ÿ
    - cron: '*/10 * * * *'
  
  workflow_dispatch:
    inputs:
      isDev:
        description: Is Dev
        type: boolean

env:
  RELEASE_URL: 'https://api.github.com/repos/anyabc/something/releases/latest'
  ENABLE_WATCH: ${{ secrets.ENABLE_WATCH_MDCX_RELEASE }}

jobs:
  # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
  watch:
    runs-on: ubuntu-latest
    steps:
      -
        run: |
          # TODO åœ¨jobä¸Šè²Œä¼¼ä¸èƒ½è¯»å–envæˆ–è€…secrets

          if [[ "${{ env.ENABLE_WATCH }}" != "true" && "${{ github.event.inputs.isDev }}" != "true" ]]; then
            exit 1
          fi
      - 
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Install apt packages
        run: sudo apt-get install -y jq
      -
        name: Check if there is a new MDCx release
        run: |
          source scripts/base.sh
          source scripts/github.sh

          VAR_VERSION="MDCX_LATEST_VERSION"
          VAR_TIME="MDCX_LATEST_TIME"

          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¿”å›å€¼ä¸ºæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç‰ˆæœ¬å·ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸ºæ›´æ–°æ—¶é—´
          getNewInfo() {
            local content=$(curl -s "${{ env.RELEASE_URL }}")
            local asset=$(echo $content | jq '.assets'| jq 'map(select(.browser_download_url | contains("-py-")))' | jq '.[0]')

            if [[ -z "$asset" ]]; then
              echo "âŒ æŸ¥æ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„assetï¼"
              return 1
            fi

            local archiveUrl=$(echo $asset | jq '.browser_download_url')
            local updatedAt=$(echo $asset | jq '.updated_at')

            if [[ -z "$archiveUrl" ]]; then
              echo "âŒ è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼"
              return 1
            fi

            if [[ -z "$updatedAt" ]]; then
              echo "âŒ è·å–æ›´æ–°æ—¶é—´å¤±è´¥ï¼"
              return 1
            fi

            local archiveFullName=$(echo $archiveUrl | grep -oi 'MDCx-py-[a-z0-9]\+.[a-z]\+')
            local archiveVersion=$(echo $archiveFullName | sed 's/MDCx-py-//g' | sed 's/\.[^.]*$//')

            local info=("$archiveVersion" "$updatedAt")
            echo "${info[@]}"
            return 0
          }

          newVersion=""
          newTime=""

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬ï¼Œè¿”å›å€¼ä¸ºtrueæˆ–falseï¼Œtrueè¡¨ç¤ºæœ‰æ–°ç‰ˆæœ¬ï¼Œfalseè¡¨ç¤ºæ²¡æœ‰æ–°ç‰ˆæœ¬
          isNewRelease() {
            # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
            local info=($(getNewInfo))
            newVersion=${info[0]}
            newTime=${info[1]}

            # è·å–å·²è®°å½•çš„ç‰ˆæœ¬ä¿¡æ¯
            local latestVersion=$(getVariable $VAR_VERSION)
            local latestTime=$(getVariable $VAR_TIME)
            echo "ğŸ“¦ å·²è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼š$latestVersion"
            echo "ğŸ“… å·²è®°å½•çš„æ›´æ–°æ—¶é—´ï¼š$latestTime"

            # ä»»æ„ä¸€ä¸ªå˜é‡ä¸ºç©ºï¼Œéƒ½ä¸è§†ä¸ºæ–°ç‰ˆæœ¬
            if [[ -z "$latestVersion" || -z "$latestTime" ]]; then
              echo "false"
              return 0
            fi

            # å¦‚æœç‰ˆæœ¬å·å’Œæ›´æ–°æ—¶é—´éƒ½ä¸åŒï¼Œè§†ä¸ºæ–°ç‰ˆæœ¬
            if [[ "$newVersion" != "$latestVersion" && "$newTime" != "$latestTime" ]]; then
              echo "true"
              return 1
            else
              echo "false"
              return 0
            fi
          }
 
          if [[ $(isNewRelease) == "true" ]]; then
            echo "ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼"
            echo "ğŸ“¦ æ–°ç‰ˆæœ¬å·ï¼š$newVersion"
            echo "ğŸ“… æ›´æ–°æ—¶é—´ï¼š$newTime"

            # è¾“å‡ºåˆ°GITHUB_OUTPUT 
            echo "newVersion=$newVersion" >> $GITHUB_OUTPUT
            echo "newTime=$newTime" >> $GITHUB_OUTPUT

            # æš‚æ—¶ç®€å•å¤„ç†ï¼Œå…ˆæ›´æ–°å˜é‡
            updateVariable $VAR_VERSION $newVersion
            updateVariable $VAR_TIME $newTime

            exit 0
          else
            echo "ğŸ” æ²¡æœ‰æ–°ç‰ˆæœ¬ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥..."
            exit 1
          fi

  # é€šçŸ¥åˆ°telegram
  notify:
    runs-on: ubuntu-latest
    needs: watch
    steps:
      -
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELE_CHAT_ID }}
          token: ${{ secrets.TELE_BOT_TOKEN }}
          message: |
            ğŸ‰ MDCxæ–°ç‰ˆæœ¬ï¼
            ğŸ“¦ æ–°ç‰ˆæœ¬å·ï¼š${{ needs.watch.outputs.newVersion }}
            ğŸ“… æ›´æ–°æ—¶é—´ï¼š${{ needs.watch.outputs.newTime }}
            ğŸ”— å‘å¸ƒé“¾æ¥ï¼š${{ env.RELEASE_URL }}
      - 
        if: ${{ github.event.inputs.isDev == 'true' }}
        run: exit 1
  
